# 博客系统



## 项目背景

实现一个博客系统，支持以下核心功能

- 用户的注册和登录

- 用户发布文章（可直接发布，保存为草稿，定时发布）

- 访问网址可直接看到所有文章及其详情

- 在文章详情内可进行评论

- 用户资料修改，如密码、头像

  

## 核心技术

- Spring/SpringMVC/SpringBoot

- Http

- MySQL/MaBatis/Redis

- Html/CSS/JavaScript/Ajax

  

## 需求分析和概要设计

项目分为一下几个模块

1. 用户模块
2. 博客显示模块
3. 博客发布模块
4. 其他模块

### 用户模块

用户模块主要负责的是用户的注册，登录，密码加盐，显示用户信息，设置用户等级，错误输入根据用户等级设置冻结

使用MySQL数据库进行储存

客户端提供登录界面和注册界面

服务端基于SpringBoot和MyBatis来进行数据库的增删查改

### 博客模块

登录成功后进入用户的文章显示主页

文章显示主页右侧排列的是该用户发布的文章，左侧显示用户个人信息，如头像，用户名，文章总数

页面上侧显示工具栏，可进入博客草稿列表，定时发布的博客列表，以往删除的博客列表，所有用户所发布的博客列表

发布的博客有三个按钮，分别为查看详情，修改，删除；功能分别为查看博客详情，进入修改页面修改，删除改文章

博客草稿有三个按钮，分别为修改，发布，删除；功能分别为进入修改页面修改草稿，发布该草稿，删除该草稿

定时发布的博客有两个按钮，分别为立即发布，删除；功能分别为立即发布该定时博客，删除该定时博客

文章详情查看左侧是作者信息，右侧是文字

博客显示支持MarkDown语法

在个人博客列表页点击*发布博客*按钮进入发布博客的界面，可以使用MarkDown语法进行编写

编写完成后可以直接发布，也可以保存为草稿，或者输入如 “2/30” 的格式表示两小时三十分钟 来定时发布博客

这三种分别可以在个人文章和所有文章列表，草稿列表，定时博客列表进行查看

服务端基于SpringBoot和MyBati来进行数据库的增删查改

### 其他模块

#### 文章评论

每次打开文章详情页时就会加载评论，也可以在评论区进行输入评论

#### 修改用户资料

待实现



## 项目创建

打开IDEA进行创建SpringBoot项目，引入以下依赖

<img src="C:\Users\riu\AppData\Roaming\Typora\typora-user-images\image-20230604180052746.png" alt="image-20230604180052746" style="zoom:67%;" />

最后的pom.xml文件为

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.7.11</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.example</groupId>
	<artifactId>demo</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>demo</name>
	<description>Demo project for Spring Boot</description>
	<properties>
		<java.version>1.8</java.version>
	</properties>
	<dependencies>
		<!-- https://mvnrepository.com/artifact/org.yaml/snakeyaml -->
		<dependency>
			<groupId>org.yaml</groupId>
			<artifactId>snakeyaml</artifactId>
			<version>2.0</version>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>
		<dependency>
			<groupId>org.mybatis.spring.boot</groupId>
			<artifactId>mybatis-spring-boot-starter</artifactId>
			<version>2.3.0</version>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-devtools</artifactId>
			<scope>runtime</scope>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>com.mysql</groupId>
			<artifactId>mysql-connector-j</artifactId>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-redis</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.session</groupId>
			<artifactId>spring-session-data-redis</artifactId>
		</dependency>
	</dependencies>

	<build>
		<plugins>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<configuration>
					<excludes>
						<exclude>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</exclude>
					</excludes>
				</configuration>
			</plugin>
		</plugins>
		<resources>

			<resource>
				<directory>src/main/resources</directory>
				<includes>
					<include>**/*.yml</include>
					<include>**/*.properties</include>
					<include>**/*.xml</include>
				</includes>
				<filtering>false</filtering>
			</resource>
			<resource>
				<directory>lib</directory>
				<includes>
					<include>**/*.jar</include>
				</includes>
			</resource>
		</resources>
	</build>

</project>

```



---



### 统一数据返回格式

我们规定，每次返回的格式为

```json
{
	statusCode: 返回的状态码
	statusCodeDescription: 状态码的描述
	data: 返回的数据
}
```



所以我创建AjaxResult类，当需要返回数据时，就调用该类中的静态方法，来达到统一格式的目的
```java
package com.example.mycnblog.common;

import lombok.Data;

import java.io.Serializable;

@Data
public class AjaxResult implements Serializable {
    // 状态码
    private int statusCode;
    // 状态码描述
    private String statusCodeDescription;
    // 返回的数据
    private Object data;

    /**
     * 操作成功调用的函数
     */
    public static AjaxResult success(Object data) {
        AjaxResult ajaxResult = new AjaxResult();
        ajaxResult.setStatusCode(200);
        ajaxResult.setStatusCodeDescription("");
        ajaxResult.setData(data);
        return ajaxResult;
    }

    public static AjaxResult success(int statusCode, Object data) {
        AjaxResult ajaxResult = new AjaxResult();
        ajaxResult.setStatusCode(statusCode);
        ajaxResult.setStatusCodeDescription("");
        ajaxResult.setData(data);
        return ajaxResult;
    }

    public static AjaxResult success(int statusCode, String statusCodeDescription, Object data) {
        AjaxResult ajaxResult = new AjaxResult();
        ajaxResult.setStatusCode(statusCode);
        ajaxResult.setStatusCodeDescription(statusCodeDescription);
        ajaxResult.setData(data);
        return ajaxResult;
    }

    /**
     * 失败调用的函数
     */
    public static AjaxResult fail(int statusCode, String statusCodeDescription) {
        AjaxResult ajaxResult = new AjaxResult();
        ajaxResult.setStatusCode(statusCode);
        ajaxResult.setStatusCodeDescription(statusCodeDescription);
        ajaxResult.setData(null);
        return ajaxResult;
    }

    public static AjaxResult fail(int statusCode, String statusCodeDescription, Object data) {
        AjaxResult ajaxResult = new AjaxResult();
        ajaxResult.setStatusCode(statusCode);
        ajaxResult.setStatusCodeDescription(statusCodeDescription);
        ajaxResult.setData(data);
        return ajaxResult;
    }
}

```

这是我们主动返回时调用的方法，我们需要在没有调用时返回同样的格式，我们需要使用SpringAOP来实现该功能

```java
package com.example.demo.config;

import com.example.demo.comon.AjaxResult;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.SneakyThrows;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.MethodParameter;
import org.springframework.http.MediaType;
import org.springframework.http.server.ServerHttpRequest;
import org.springframework.http.server.ServerHttpResponse;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdvice;

@ControllerAdvice
public class ResponseAdvice implements ResponseBodyAdvice {

    @Autowired
    private ObjectMapper objectMapper;

    @Override
    public boolean supports(MethodParameter returnType, Class converterType) {
        return true;
    }

    @SneakyThrows
    @Override
    public Object beforeBodyWrite(Object body, MethodParameter returnType, MediaType selectedContentType, Class selectedConverterType, ServerHttpRequest request, ServerHttpResponse response) {
        if (body instanceof AjaxResult) {
            return body;
        }
        if (body instanceof String) {
            return objectMapper.writeValueAsString(AjaxResult.success(body));
        }
        return AjaxResult.success(body);
    }
}

```



---



### 统一异常处理

虽然我们可以返回统一的数据格式，但是当我们程序出现异常或错误时，我们不能把异常信息返回到客户端，因为这会增加我们

程序的泄露风险，所以我们需要把异常信息改变再返回

```java
package com.example.mycnblog.component;

import com.example.mycnblog.common.AjaxResult;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;

@ControllerAdvice
@ResponseBody
public class ExceptionAdvice {

    @ExceptionHandler(Exception.class)
    public AjaxResult exceptionHandler(Exception exception) {
        return AjaxResult.fail(-2, "Exception异常");
    }

    @ExceptionHandler(RuntimeException.class)
    public AjaxResult runtimeExceptionHandler(RuntimeException runtimeException) {
        return AjaxResult.fail(-2, "运行时异常");
    }

    @ExceptionHandler(NullPointerException.class)
    public AjaxResult nullExceptionHandler(NullPointerException nullPointerException) {
        return AjaxResult.fail(-2, "空指针异常");
    }

    // TODO 出现运行时异常的处理场所
}

```

以此类推，我们可以细分异常返回来提升出现错误时团队提交错误的详细信息



---



### 实现用户模块

#### 编写数据库代码

##### 数据库设计

我们需要7个字段

id 字段表示用户id，username 字段表示用户名，password 字段表示用户密码，photo表示该用户头像，

create_time表示该用户创建时间，update_time 表示用户修改修改时间，state表示用户状态，

error_number表示用户登录输错几次密码，freeze_time表示用户需要冻结到的时间

所有字段都要设置 not null，id字段设置自增主键，username 字段设置唯一约束来保证用户登录，password字段设置65位来和密码加盐算法来配合

```mysql
create database if not exists mycnblog;

use mycnblog;

drop table if exists userinfo;

create table if not exists userinfo (
  id int(11) not null auto_increment primary key,
  username varchar(100) not null unique,
  password varchar(65) not null,
  photo varchar(500) not null default '',
  create_time datetime not null default current_timestamp,
  update_time datetime not null default current_timestamp,
  state int(11) not null default '0',
  error_number int(11) not null default '0',
  freeze_time datetime not null default current_timestamp
) engine=innodb auto_increment=4 default charset=utf8mb4

insert into userinfo(username, password) values('admin', '111111');
insert into userinfo(usernaem, password) values('ding', '111111');
```



---

##### 配置yml文件

```yaml
# session 配置
server:
  servlet:
    session:
      timeout: 1800

spring:
  # 配置 redis
  redis:
    database: 15
    host: ****** # 服务器公网ip
    port: 6379 # 服务器Redis服务端口号

  # session 配置
  session:
    store-type: redis
    redis:
      flush-mode: on_save
      namespace: spring:session

  # 配置数据库的连接字符串
  datasource:
    url: jdbc:mysql://localhost:3306/mycnblog?useUnicode=true&characterEncoding=UTF-8&useSSL=false
    username: root
    password: "111111"
    driver-class-name: com.mysql.cj.jdbc.Driver
    
# 设置 Mybatis 的 xml 保存路径
mybatis:
  mapper-locations: classpath:mapper/*Mapper.xml
  configuration: # 配置打印 MyBatis 执行的 SQL
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
    
# 配置打印 MyBatis 执行的 SQL
logging:
  level:
    com:
      example:
        demo: debug
```



---

##### 创建entity.userinfo实体类

```java
package com.example.mycnblog.entity;

import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

@Data
public class Articleinfo implements Serializable {
    private Integer id;
    private String title;
    private String content;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private LocalDateTime createtime;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private LocalDateTime updatetime;
    private Integer uid;
    private Integer rcount;
    private Integer state;
}

```

为了和数据库字段对应，某些属性没有遵守小驼峰规范



---

##### 创建mapper.userMapper接口

```java
package com.example.mycnblog.mapper;

import com.example.mycnblog.entity.Userinfo;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface UserMapper {

    /**
     * 注册添加user用户
     * @param userinfo 要插入的用户
     * @return 返回受影响的行数
     */
    int insertUser(Userinfo userinfo);

    /**
     * 根据用户名来查找用户，用来对接登录功能
     * @param username 需要查找的用户名
     * @return 返回查找到的用户
     */
    Userinfo getUserByName(@Param("username") String username);

    /**
     * 根据用户 id 来查找用户，用来对接展示作者信息功能
     * @param id 要查找的作者 id
     * @return 返回查找到作者的 id
     */
    Userinfo getAuthorById(@Param("id") Integer id);

    /**
     * 修改用户的 state， freeze_time，error_number, 输错五次后继续输入，修改冻结时间，增加等级，重置输入错误次数
     * @param userinfo 登录成功后要修改的用户及其数据
     * @return 返回受影响的行数
     */
    int updateUserLoginParameters(Userinfo userinfo);

    /**
     * 修改用户的 error_number和 state , 当用户输入密码错误超过五次时，需要提升用户等级和重置输入错误次数
     * @param id 要修改的用户 id
     * @param error_number 要修改的新的 error_number
     * @param state 要修改的新的 state
     */
    int updateUserError_numberState(@Param("id")Integer id, @Param("error_number") Integer error_number, @Param("state") Integer state);

    /**
     * 修改用户的 error_number，当用户输入错误时就要修改用户的输入错误次数
     * @param id 输入错误密码的用户 id
     * @param error_number 要修改的 error_number
     */
    int updateUserError_number(@Param("id")Integer id, @Param("error_number") Integer error_number);

    /**
     * 根据用户 id 来返回该用户数据库存储的加盐密码
     * @param id 用户id
     * @return 返回该用户数据库密码
     */
    String selectUserPassword(@Param("id") Integer id);

    /**
     * 根据用户 id 修改用户的密码
     * @param id 用户id
     * @param finalPassword 要修改的数据库最终密码
     * @return 返回受影响的行数
     */
    int updateUserPassword(@Param("id") Integer id, @Param("finalPassword") String finalPassword);

    // TODO 修改用户头像
}

```



---

##### 实现userMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mycnblog.mapper.UserMapper">

    <!--suppress SqlInsertValues -->
    <insert id="insertUser">
        insert into userinfo(username, password) values (#{username}, #{password})
    </insert>

    <select id="getUserByName" resultType="com.example.mycnblog.entity.Userinfo">
        select *  from userinfo where username = #{username}
    </select>

    <select id="getAuthorById" resultType="com.example.mycnblog.entity.Userinfo">
        select * from userinfo where id = #{id}
    </select>

    <update id="updateUserLoginParameters">
        update userinfo set state = #{state}, freeze_time = #{freeze_time}, error_number = #{error_number} where id = #{id}
    </update>

    <update id="updateUserError_numberState">
        update userinfo set error_number = #{error_number}, state = #{state} where id = #{id}
    </update>

    <update id="updateUserError_number">
        update userinfo set error_number = #{error_number} where id = #{id}
    </update>

    <select id="selectUserPassword" resultType="java.lang.String">
        select password from userinfo where id = #{id}
    </select>

    <update id="updateUserPassword">
        update userinfo set password = #{finalPassword} where id = #{id}
    </update>
</mapper>
```

xml和mapper接口顺序一一对应



----



#### 前后端接口

##### 登录注册接口

请求：

> ```http
> POST /user/login HTTP/1.1
> Content-Type: application/x-www-form-urlencoded
> 
> username=zhangsan&password=123
> ```

响应：

>```http
>HTTP/1.1 200 OK
>Content-Type: application/json
>
>{
>	statusCode: 200
>	statusCodeDescription: ""
>	data: 1 | ""
>}  
>```

当登录成功时，data就为1，登录失败冻结时，会提示解冻时间

---

##### 获取个人信息

请求：

> ```http
> POST /user/userInfo HTTP/1.1
> ```

响应：

这里我们要注意，我们需要知道登录用户的发布博客数量，但原实体类没有这个属性，所以我们创建一个视图来表达这次返回的数据

```java
package com.example.demo.entity.vo;

import com.example.demo.entity.Userinfo;
import lombok.Data;

import java.io.Serializable;

@Data
public class UserinfoVO extends Userinfo implements Serializable {
    private int articleNumber;
}
```

所以我们返回的数据就是，其中articleNumber就是所发布的博客总数


> ```http
> HTTP/1.1 200 OK
> Content-Type: application/json
> 
> {
> 	statusCode: 200
> 	statusCodeDescription: ""
> 	data: {
> 		id: 
>     		usernaem:
>     		password:
>     		..
>     		articleNumber: **
> 	}
>     }    
> ```

---

##### 退出登录接口

每当用户退出登录时，我们就把该用户存储的 session 删除，防止该用户还能访问其他需要登录的借口和页面

请求：

```http
POST /user/userInfo HTTP/1.1
```

响应：

```java
HTTP/1.1 200 OK
Content-Type: application/json

{
	statusCode: 200
	statusCodeDescription: ""
	data: 1 | 0
}   
```

当删除 session 成功时就 data 数据就为1，删除失败时就为0

---

##### 获取作者信息接口

##### articleController接口

当我们点进博客详情页时，我们需要获取到作者的详情展示

请求：

```http
POST /user/userInfo HTTP/1.1

{
	"id": 
}
```

响应：

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: userinfoVO
} 
```



---



#### 服务端开发

创建三个包分别为mapper，service，controller，分别为持久层，服务层，控制层

主要实现四个方法，分别为register，userLogin，showUserInformation，userLogout

功能分别为注册，用户登录，显示用户信息，用户退出登录

在这之前我吗需要创建两个类，一个存放程序所需的常量，一个存放用户等级和冻结时间的映射，代码如下

```java
package com.example.demo.common;

public class AppVariable {

    public static final String USER_SESSION_KEY = "USER_SESSION_KEY";
}
```

```java
package com.example.demo.common;

import java.util.HashMap;

// 账号冻结时间列表
public class FreezeTimeEnum {

    private static Object lock = new Object();

    private static volatile HashMap<Integer, Integer> stateMapTime = null;

    public static HashMap<Integer, Integer> getFreezeTimeList() {
        if (stateMapTime == null) {
            synchronized (lock) {
                if (stateMapTime == null) {
                    stateMapTime = new HashMap<>();
                    stateMapTime.put(0, 10);
                    stateMapTime.put(1, 60);
                    stateMapTime.put(2, 300);
                }
            }
        }
        return stateMapTime;
    }
}
```



---

##### 加盐算法

用户的密码我们不能明文存储到数据库中，所以我们用加盐算法来加密用户密码，代码如下

```java
package com.example.mycnblog.common;

import org.springframework.util.DigestUtils;

import java.util.UUID;

public class PasswordUtils {

    /**
     * 加密(加盐)
     * @param password 用户输入的密码
     * @return 用于数据库存储的密码
     */
    public static String passwordEncrypt(String password) {
        // 1. 得到盐值
        String salt = UUID.randomUUID().toString().replace("-", "");
        // 2. 得到 md5 加密后的密码, 需要和盐一起加密
        String saltPassword = DigestUtils.md5DigestAsHex((salt + password).getBytes());
        // 返回数据库中存储的密码，也就是前三十二位为盐值，分隔符，后三十二位md5加密密码
        String finalPassword = salt + "$" + saltPassword;
        return finalPassword;
    }

    /**
     * 以固定的盐值得到最终密码
     * @param password 用户输入的明文密码
     * @param salt 从数据库密码中得到的盐值
     * @return 返回最终密码和数据库密码比较
     */
    public static String passwordEncrypt(String password, String salt) {
        String saltPassword = DigestUtils.md5DigestAsHex((salt + password).getBytes());
        String finalPassword = salt + "$" + saltPassword;
        return finalPassword;
    }

    /**
     * 检查数据库密码和经过加密的用户明文密码是否相同
     * @param password 用户输入明文密码
     * @param finalPassword 数据库中密码
     * @return 相等返回true，不相等返回false
     */
    public static boolean passwordDecrypt(String password, String finalPassword) {
        // 得到盐值
        String salt = finalPassword.split("\\$")[0];
        String decryptPassword = PasswordUtils.passwordEncrypt(password, salt);
        return decryptPassword.equals(finalPassword);
    }

}

```



---

##### 控制层

```java
package com.example.mycnblog.controller;

import com.example.mycnblog.common.*;
import com.example.mycnblog.entity.Userinfo;
import com.example.mycnblog.entity.vo.UserinfoVO;
import com.example.mycnblog.service.ArticleService;
import com.example.mycnblog.service.UserService;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import java.text.ParseException;

@RequestMapping("/user")
@RestController
public class UserController {

    @Autowired
    private UserService userService;

    @Autowired
    private ArticleService articleService;

    @PostMapping("/reg")
    public AjaxResult register(Userinfo userinfo) {
        if (userinfo == null || !StringUtils.hasLength(userinfo.getUsername())
                || !StringUtils.hasLength(userinfo.getPassword())
                || userinfo.getPassword().length() < 6) {
            return AjaxResult.fail(0, "参数错误");
        }
        int row = userService.insertUserService(userinfo);
        return AjaxResult.success(row);
    }

    @RequestMapping("/login")
    public AjaxResult userLogin(HttpServletRequest request, String username, String password) throws ParseException {
        if (!StringUtils.hasLength(username) || !StringUtils.hasLength(password)) {
            return AjaxResult.fail(0, "参数错误");
        }
        // 得到用户对象
        Userinfo userinfo = userService.getUserByNameService(username);
        if (userinfo == null || !StringUtils.hasLength(userinfo.getUsername())
                || !StringUtils.hasLength(userinfo.getPassword())) {
            return AjaxResult.fail(-1, "非法访问");
        }
        return userService.userLoginService(password, userinfo, request);
    }

    @RequestMapping("/showinfo")
    public AjaxResult showUserInformation(@RequestParam("state") Integer state, HttpServletRequest request) {
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        Integer uid = userinfo.getId();
        UserinfoVO userinfoVO = new UserinfoVO();
        BeanUtils.copyProperties(userinfo, userinfoVO);
        userinfoVO.setArticleNumber(articleService.getArticleNumberService(uid, state));
        return AjaxResult.success(userinfoVO);
    }

    @RequestMapping("/logout")
    public AjaxResult userLogout(HttpSession session) {
        session.removeAttribute(AppVariable.USER_SESSION_KEY);
        if (session.getAttribute(AppVariable.USER_SESSION_KEY) != null) {
            // 删除失败，返回数据 0
            return AjaxResult.success(0);
        }
        return AjaxResult.success(1);
    }

    @RequestMapping("/showauthor")
    public AjaxResult showAuthorInformation(Integer id) {
        if (id == null || id <= 0) {
            return AjaxResult.fail(0, "参数错误");
        }
        Userinfo userinfo = userService.getAuthorByIdService(id);
        if (userinfo == null || userinfo.getId() < 0) {
            return AjaxResult.success(-1, "非法访问");
        }
        userinfo.setPassword("");
        UserinfoVO userinfoVO = new UserinfoVO();
        BeanUtils.copyProperties(userinfo, userinfoVO);
        userinfoVO.setArticleNumber(articleService.getArticleNumberService(id, 0));
        return AjaxResult.success(userinfoVO);
    }

    @RequestMapping("/updatepass")
    public AjaxResult updatePassword(String beforePassword, String afterPassword, HttpServletRequest request) {
        if (!StringUtils.hasLength(beforePassword)
            || !StringUtils.hasLength(afterPassword) || afterPassword.length() < 6) {
            return AjaxResult.fail(0, "参数错误");
        }
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        String databasePassword = userService.getUserPassword(userinfo.getId());
        if (!PasswordUtils.passwordDecrypt(beforePassword, databasePassword)) {
            return AjaxResult.fail(0, "密码输入错误，请重新输入");
        }
        userinfo.setPassword(PasswordUtils.passwordEncrypt(afterPassword));
        int row = userService.updateUserPasswordService(userinfo);
        return AjaxResult.success(row);
    }
}

```





##### 服务层

```java
package com.example.mycnblog.service;

import com.example.mycnblog.common.AjaxResult;
import com.example.mycnblog.common.AppVariable;
import com.example.mycnblog.common.FreezeTimeEnum;
import com.example.mycnblog.common.PasswordUtils;
import com.example.mycnblog.entity.Userinfo;
import com.example.mycnblog.mapper.UserMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.util.Date;
import java.util.HashMap;

@Service
public class UserService {

    @Autowired
    private UserMapper userMapper;

    private final Object lock = new Object();

    /**
     * 用户登录的逻辑
     * @param password 登录密码
     * @param userinfo 根据用户名查找到的用户
     * @param request 请求变量
     * @return 返回AjaxResult格式
     * @throws ParseException 异常忽略
     */
    public AjaxResult userLoginService(String password, Userinfo userinfo, HttpServletRequest request) throws ParseException {

        HashMap<Integer, Integer> freezeTimeMap = FreezeTimeEnum.getFreezeTimeList();
        int errorNumber = userinfo.getError_number();
        int state = userinfo.getState();
        SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd hh:mm:ss");
        if (errorNumber == 5) {
            // 1. 检差当前的 error_num 当等于5时，根据state来设置冻结时间
            int freeTimeDiffer = freezeTimeMap.get(state);
            LocalDateTime freezeTime = LocalDateTime.now().plusSeconds(freeTimeDiffer);
            userinfo.setFreeze_time(freezeTime);
            userinfo.setError_number(errorNumber + 1);
            userinfo.setState(state < 2 ? state + 1 : 2);
            int row = userMapper.updateUserLoginParameters(userinfo);
            Thread thread = new Thread(() -> {
                synchronized (lock) {
                    try {
                        lock.wait(FreezeTimeEnum.getFreezeTimeList().get(state) * 1000);
                        int i = userMapper.updateUserError_number(userinfo.getId(), 0);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            });
            thread.start();
            return AjaxResult.fail(1, "账户已冻结，请 " +
                    (freeTimeDiffer >= 60 ? (freeTimeDiffer / 60) + "分钟后" : freeTimeDiffer + "秒后") + "重试");
        } else if (errorNumber > 5) {
            // 2. error_number 大于 5 时，返回剩余冻结时间
            String[] times = userinfo.getFreeze_time().toString().split("T");
            Date date = simpleDateFormat.parse(times[0] + " " + times[1]);
            long time = (date.getTime() + freezeTimeMap.get(state) - System.currentTimeMillis()) / 1000;
            String responseTime;
            if (time > 60) {
                responseTime = (int) (time / 60) + "分钟  ";
                responseTime += time % 60 + "秒";
            } else {
                responseTime = (int) time + "秒";
            }
            return AjaxResult.fail(1, "账号已被冻结，请 " + responseTime + " 后重试");
        }

        // 3. 没达到设定的 5 次就再次判断密码是否正确
        if (!PasswordUtils.passwordDecrypt(password, userinfo.getPassword())) {
            // 隐藏敏感信息   密码错误 再次增加 error_number
            userMapper.updateUserError_number(userinfo.getId(), errorNumber + 1);
            return AjaxResult.fail(-1, "非法访问");
        }

        // 密码正确，清除 state 为0，error_number为0
        int row = userMapper.updateUserError_numberState(userinfo.getId(), 0, 0);
        HttpSession session = request.getSession(true);
        userinfo.setPassword("");
        session.setAttribute(AppVariable.USER_SESSION_KEY, userinfo);
        return AjaxResult.success(row);
    }

    /**
     * 添加用户，用于注册
     * @param userinfo 要添加的用户
     * @return 返回受影响的行数
     */
    public int insertUserService(Userinfo userinfo) {
        userinfo.setPassword(PasswordUtils.passwordEncrypt(userinfo.getPassword()));
        return userMapper.insertUser(userinfo);
    }

    /**
     * service层 根据用户名查找用户
     * @param username 用户名
     * @return 返回数据库中的用户信息
     */
    public Userinfo getUserByNameService(String username) {
        return userMapper.getUserByName(username);
    }

    /**
     * service层 根据用户 id 查找作者
     * @param id 用户 id
     * @return 返回数据库中的作者信息
     */
    public Userinfo getAuthorByIdService(Integer id) {
        return userMapper.getAuthorById(id);
    }

    /**
     * service层 根据用户 id 来查找密码
     * @param id 用户 id
     * @return 返回数据库中的加密密码
     */
    public String getUserPassword(Integer id) {
        return userMapper.selectUserPassword(id);
    }

    /**
     * service层 修改当前用户的密码
     * @param userinfo 当前用户
     * @return 返回受影响的行数
     */
    public int updateUserPasswordService(Userinfo userinfo) {
        return userMapper.updateUserPassword(userinfo.getId(), userinfo.getPassword());
    }
}

```



----

 

#### 客户端开发

##### 注册页面

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册页面</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/login.css">
    <script src="js/jquery.min.js"></script>
</head>

<body>
    <!-- 导航栏 -->
    <div class="nav">
        <img src="img/system.png" alt="">
        <span class="title">我的博客系统</span>
        <!-- 用来占据中间位置 -->
        <span class="spacer"></span>
        <a href="blog_list.html">主页</a>
        <a href="login.html">登陆</a>
    </div>
    <!-- 版心 -->
    <div class="login-container">
        <!-- 中间的注册框 -->
        <div class="login-dialog">
            <h3>注册</h3>
            <div class="row">
                <span>用户名</span>
                <input type="text" id="username" placeholder="请输入用户名">
            </div>
            <div class="row">
                <span>密码</span>
                <input type="password" id="password" placeholder="密码不少于6位">
            </div>
            <div class="row">
                <span>确认密码</span>
                <input type="password" id="password2" placeholder="请输入确认密码">
            </div>
            <div class="row">
                <button id="submit" onclick="mysub()">提交</button>
            </div>
        </div>
    </div>

    <script>
        // 提交注册事件
        function mysub(){
           // 1.非空效验
           var username = jQuery("#username");
           var password = jQuery("#password");
           var password2 = jQuery("#password2");
           if(username.val()==""){
            alert("请输入用户名！");
            username.focus(); // 将鼠标光标设置到用户名控件
            return;
           }
           if(password.val()==""){
            alert("请输入密码！");
            password.focus();
            return;
           }
           if(password2.val()==""){
            alert("请输入确认密码！");
            password2.focus();
            return;
           }
           // 2.判断两次密码是否一致
           if(password.val()!=password2.val()){
            alert("两次密码输入的不一致，请先检查！");
            password.focus();
            return;
           }
           // 3.ajax 提交请求 
            jQuery.ajax({
                url: '/user/reg',
                type: 'POST',
                data:{"username": username.val(), "password": password.val()},
                success:function(result){
                    // 响应的结果
                    if(result!=null && result.statusCode==200 && result.data==1){
                        // 执行成功
                        if(confirm("恭喜：注册成功！是否要跳转到登录页面？")){
                            location.href = "/login.html";
                        }
                    } else{
                            alert("抱歉执行失败，请稍后再试！");
                        }
                }
            });
        }
    </script>
</body>
</html>
```

注册页面CSS：

```css
.login-container {
    width: 100%;
    height: calc(100% - 50px);
    display: flex;
    justify-content: center;
    align-items: center;
}

.login-dialog {
    width: 400px;
    height: 400px;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
}

.login-dialog h3 {
    padding: 50px 0;
    text-align: center;
}

.login-dialog .row {
    height: 50px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.login-dialog .row span {
    display: block;
    width: 100px;
    font-weight: 700;
}

.login-dialog .row input {
    width: 200px;
    height: 40px;
    line-height: 40px;
    font-size: 24px;
    border-radius: 10px;
    border: none;
    outline: none;
    text-indent: 10px;
    background-color:rgba(255, 255, 255, 0.8);
}

.login-dialog button {
    width: 300px;
    height: 50px;
    color: white;
    background-color: green;
    border: none;
    border-radius: 10px;
}

.login-dialog button:active {
    background-color: #666;
}

```



公共页面CSS：

```css
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* 设置整体页面高度 */
html, body {
    height: 100%;
    /* background-image: url(../img/cat.jpg); */
    background-image: linear-gradient(120deg, #d4fc79 0%, #96e6a1 100%);
    background-position: center center;
    background-size: cover;
    background-repeat: no-repeat;
}

/* 上方导航栏 */
.nav {
    width: 100%;
    height: 50px;
    background-color: rgba(51, 51, 51, 0.4);
    color: #fff;

    display: flex;
    justify-content: left;
    align-items: center;
}

/* 导航栏中的图标 */
.nav img {
    width: 40px;
    height: 40px;
    margin-left: 30px;
    margin-right: 10px;
    border-radius: 50%;
}

/* 导航栏中的占位器 */
.nav .spacer {
    width: 58%;
}

/* 导航栏中的按钮 */
.nav a {
    color: #fff;
    text-decoration: none;
    padding: 0 10px;
}

/* 页面内容容器, 版心 */
.container {
    /* 使用 calc 计算高度 */
    height: calc(100% - 50px);
    /* 设置版心宽度 */
    width: 1000px;
    /* 水平居中 */
    margin: 0 auto;
    /* 使用弹性布局 */
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* 左侧部分, 用来放置用户信息 */
.container-left {
    height: 100%;
    width: 200px;
}

/* 右侧部分, 用来放置正文 */
.container-right {
    height: 100%;
    /* 和左侧部分中间留出 5px 间隙 */
    width: 795px;
    /* 如果内容溢出就自动加上滚动条 */
    overflow: auto;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
}

/* 展示用户信息的卡片 */
.card {
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    padding: 30px;
}

/* 用户头像 */
.card img {
    width: 140px;
    height: 140px;
    border-radius: 50%;
}

/* 用户名 */
.card h3 {
    text-align: center;
    padding: 10px;
}

/* 用户 github 链接 */
.card a {
    display: block;
    text-align: center;
    color: #999;
    text-decoration: none;
    padding: 10px;
}

/* 展示文章数目的面板 */
.card .counter {
    padding: 5px;
    display: flex;
    justify-content: space-around;
}
```



---

##### 登录页面

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登陆页面</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/login.css">
    <script src="js/jquery.min.js"></script>
</head>

<body>
    <!-- 导航栏 -->
    <div class="nav">
        <img src="img/system.png" alt="">
        <span class="title">我的博客系统</span>
        <!-- 用来占据中间位置 -->
        <span class="spacer"></span>
        <a href="blog_list.html">主页</a>
        <a href="reg.html">注册</a>
    </div>
    <!-- 版心 -->
    <div class="login-container">
        <!-- 中间的登陆框 -->
        <div class="login-dialog">
            <h3>登陆</h3>
            <div class="row">
                <span>用户名</span>
                <input type="text" id="username" placeholder="请输入用户名">
            </div>
            <div class="row">
                <span>密码</span>
                <input type="password" id="password" placeholder="请输入密码">
            </div>
            <div class="row">
                <button id="submit" onclick="mysub()">提交</button>
            </div>
        </div>
    </div>

    <script>
        function mysub() {
            // 非空效验
            var username = jQuery("#username");
            var password = jQuery("#password");
            if (username.val() == "") {
                alert("请输入用户名!");
                username.focus();
                return;
            }
            if (password.val() == "") {
                alert("请输入密码!");
                password.focus();
                return;
            }
            // ajax 请求登录接口
            jQuery.ajax({
                url: '/user/login',
                type: 'post',
                data: {"username": username.val(), "password": password.val()},
                success: function(result) {
                    if (result != null && result.statusCode == 200 && result.data == 1) {
                        // 登录成功
                        location.href = "myblog_list.html";
                    } else if (result != null && result.statusCode == 1 && result.statusCodeDescription != null) {
                        alert(result.statusCodeDescription);
                    } else {
                        // 登录失败
                        alert("登录失败，用户名或密码输入错误，请检查");
                    }
                }

            }); 
        }

    </script>
</body>

</html>
```

登录页面CSS同上



---

### 实现博客模块

#### 编写数据库代码

##### 数据库设计

需要七个字段

id字段表示当前博客的唯一id，自增主键；title非空表示博客标题，content非空表示文章正文（支持MarkDown语法）

create_time表示博客创建时间非空，update_time表示博客最近修改的时间非空，uid表示这篇博客的所属用户

rcount表示该博客的点击量，state表示博客的状态默认0来区分博客的类别（0表示发布的博客，1表示博客草稿，2表示定时发布的博客，3表示以往删除的博客）

```mysql
create database if not exists mycnblog;

use mycnblog;

drop table if exists articleinfo;

create table if not exists articleinfo (
  id int(11) not null auto_increment primary key,
  title varchar(100) not null,
  content text not null,
  photo varchar(500) not null default '',
  create_time datetime not null default current_timestamp,
  update_time datetime not null default current_timestamp,
  uid int(11) not null,
  rcount int(11) not null default 1,
  state int not null defaullt 1
) engine=innodb auto_increment=4 default charset=utf8mb4

insert into articleinfo(title, content, uid) values('JavaSE', 'JavaSE学习正文', 1);
insert into articleinfo(title, content, uid ) values('MySQL', 'MySQL学习正文', 1);
```



---

##### 创建entity.articlefinfo实体类

```java
package com.example.mycnblog.entity;

import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

@Data
public class Articleinfo implements Serializable {
    private Integer id;
    private String title;
    private String content;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private LocalDateTime createtime;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private LocalDateTime updatetime;
    private Integer uid;
    private Integer rcount;
    private Integer state;
}

```



---

##### 创建mapper.articleinfoMapper接口

```java
package com.example.mycnblog.mapper;

import com.example.mycnblog.entity.Articleinfo;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;

@Mapper
public interface ArticleMapper {

    /**
     * 根据用户id来得到该作者的所有博客数量，用于显示个人信息
     *
     * @param uid   用户 id
     * @param state 返回博客的类型 0：发布的博客 1：博客草稿 2：定时发布的博客 3：删除的博客记录
     * @return 返回该用户博客数量
     */
    int getArticleNumberByuid(@Param("uid") Integer uid, @Param("state") Integer state);

    /**
     * 得到表中所有博客数量，用于分页操作
     * @return 返回博客总数
     */
    int getArticleNumber();

    /**
     * 得到该用户的所有发布博客
     * @param uid 该用户 id
     * @return 返回博客列表
     */
    List<Articleinfo> getMyList(@Param("uid") Integer uid);

    /**
     * 删除某篇博客当该作者操作时（其实时放入回收站）
     * @param id 博客id
     * @param uid 作者 id
     * @return 返回受影响的行数
     */
    int updateToDel(@Param("id") Integer id, @Param("uid") Integer uid);

    /**
     * 根据文章id来得到该博客详情
     * @param id 博客 id
     * @return 返回博客数据
     */
    Articleinfo getArticleDetail(@Param("id") Integer id);

    /**
     * 当有人点金该文章详情时就增加点击量
     * @param id 该博客 id
     * @return 受影响的行数
     */
    int incrementRCount(@Param("id") Integer id);

    /**
     * 发布博客（草稿博客和正常博客），需要添加标题，正文，作者，状态
     * @param articleinfo 要保存的博客信息
     * @return 返回受影响的行数
     */
    int insertArticle(Articleinfo articleinfo);

    /**
     * 当博客需要定时发布时，调用此接口，额外需要保存创建时间和修改时间
     * @param articleinfo 保存的博客信息
     * @return 返回受影响的行数
     */
    int insertArticleTime(Articleinfo articleinfo);

    /**
     * 进入修改页面才设置为定时发布博客
     * @param articleinfo 要修改博客的数据
     * @return 返回受影响的行数
     */
    int updateTimeArticle(Articleinfo articleinfo);

    /**
     * 从修改页面发布博客，额外修改修改时间
     * @param articleinfo 需要修改的博客数据
     * @return 返回受影响的行数
     */
    int updateArticle(Articleinfo articleinfo);

    /**
     * 分页查询
     * @param psize   每页显示数目
     * @param offsize 所跳过的数目
     * @return 返回查询到的博客
     */
    List<Articleinfo> getListByPage(@Param("psize") Integer psize, @Param("offsize") Integer offsize);

    /**
     * 在个人主页得到所有的发布（state == 1）博客
     * @param uid 博客作者 id
     * @return 返会发布博客列表
     */
    List<Articleinfo> getDraftList(@Param("uid") Integer uid);

    /**
     * 查询表中所有的定时发布的博客，来检查是否到时间发布
     * @return 返回所有的定时发布博客
     */
    List<Articleinfo> getTimeArticle();

    /**
     * 得到该用户的所有定时发布博客（state == 2）
     * @param uid 该用户id
     * @return 返回所有的定时发布博客
     */
    List<Articleinfo> getTimeList(@Param("uid") Integer uid);

    /**
     * 立即发布某一篇定时博客，还要修改发布时间和修改时间
     * @param id 该博客 id
     * @param uid 博客作者 id， 用于验证
     * @return 返回受影响的行数
     */
    int publishNowArticle(@Param("id") Integer id, @Param("uid") Integer uid);

    /**
     * 当定时发布的博客时间到时，主动发布博客，修改状态，不用修改时间
     * @param id 要发布的博客id
     */
    int publishCheckTime(@Param("id") Integer id);

    /**
     * 得到该用户以往删除的博客
     * @param uid 该用户id
     * @return 返回以往删除过的博客
     */
    List<Articleinfo> getDelList(@Param("uid") Integer uid);

    int deleteTrue(@Param("id") Integer id, @Param("uid") Integer uid);

}
```



---

##### 实现articleinfoMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mycnblog.mapper.ArticleMapper">

    <select id="getArticleNumberByuid" resultType="java.lang.Integer">
        select count(*) from articleinfo where uid = #{uid} and state = #{state}
    </select>

    <select id="getArticleNumber" resultType="java.lang.Integer">
        select count(*) from articleinfo
    </select>

    <select id="getMyList" resultType="com.example.mycnblog.entity.Articleinfo">
        select * from articleinfo where uid = #{uid} and state = 0
    </select>

    <update id="updateToDel">
        update articleinfo set state = 3 where id = #{id} and uid = #{uid}
    </update>

    <select id="getArticleDetail" resultType="com.example.mycnblog.entity.Articleinfo">
        select * from articleinfo where id = #{id}
    </select>

    <update id="incrementRCount">
        update articleinfo set rcount = rcount + 1 where id = #{id} and uid = #{uid}
    </update>

    <insert id="insertArticle">
        insert into articleinfo(title, content, uid, state) values(#{title}, #{content}, #{uid}, #{state})
    </insert>

    <insert id="insertArticleTime">
        insert into articleinfo(title, content, createtime, updatetime, uid, state)
        values(#{title}, #{content}, #{createtime}, #{updatetime}, #{uid}, #{state})
    </insert>

    <update id="updateTimeArticle">
        update articleinfo set title = #{title}, content = #{content}, updatetime = #{updatetime}, createtime = #{createtime}, state = #{state}
        where id = #{id} and uid = #{uid}
    </update>

    <update id="updateArticle">
        update articleinfo set title = #{title}, content = #{content}, updatetime = #{updatetime}, state = #{state}
        where id = #{id} and uid = #{uid}
    </update>

    <select id="getListByPage" resultType="com.example.mycnblog.entity.Articleinfo">
        select * from articleinfo limit #{psize} offset #{offsize}
    </select>

    <select id="getDraftList" resultType="com.example.mycnblog.entity.Articleinfo">
        select * from articleinfo where uid = #{uid} and state = 1
    </select>

    <select id="getTimeArticle" resultType="com.example.mycnblog.entity.Articleinfo">
        select * from articleinfo where state = 2
    </select>

    <select id="getTimeList" resultType="com.example.mycnblog.entity.Articleinfo">
        select * from articleinfo where state = 2 and uid = #{uid}
    </select>

    <update id="publishNowArticle">
        update articleinfo set state = 0, createtime = now(), updatetime = now() where id = #{id} and uid = #{uid}
    </update>

    <update id="publishCheckTime">
        update articleinfo set state = 0 where id = #{id}
    </update>

    <select id="initGetArticleList" resultType="com.example.mycnblog.entity.Articleinfo">
        select * from articleinfo where state = #{state} and uid = #{uid}
    </select>

    <select id="getDelList" resultType="com.example.mycnblog.entity.Articleinfo">
        select * from articleinfo where state = 3 and uid = #{uid}
    </select>

    <delete id="deleteTrue">
        delete from articleinfo where id = #{id} and uid = #{uid}
    </delete>

</mapper>
```

mapper接口中与xml文件一一对应



---

#### 前后端接口

##### 查询个人信息接口

请求：state参数表示当前是什么页面，发布博客列表页面就显示的是发布博客的总数，其他类似

```http
POST /user/showinfo HTTP/1.1

{
	state:
}
```

响应：返回的是用户表的视图

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: userinfoVO
} 
```



---

##### 个人已发布博客查找接口

请求：

```http
POST /art/mylist HTTP/1.1
```

响应：

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: List<Article>
} 
```



---

##### 个人博客草稿查找接口

请求：

```http
POST /art/draftlist HTTP/1.1
```

响应：

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: List<Article>
} 
```



---

##### 个人定时发布博客查找接口

请求：

```http
POST /art/timelist HTTP/1.1
```

响应：

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: List<Article>
} 
```



---

##### 个人已删除的博客历史记录借口

请求：

```http
POST /art/dellist HTTP/1.1
```

响应：

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: List<Article>
} 
```



---

##### 所有用户发布的博客查找接口

请求：两个参数，pindex参数表示当前页码，psize表示当前页面可以展示的博客数量

```http
POST /art/listpage HTTP/1.1

{
	pindex:
	psize:
}
```

响应：

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: List<Article>
} 
```



---

##### 博客增加接口

一共三个接口，分别为发布博客接口，保存为草稿接口，定时发布接口



请求：一共两个参数，一个表示博客标题，一个表示博客正文

```http
POST /art/add HTTP/1.1

{
	title:
	content:
}
```

响应：data数据 1表示成功，0表示失败

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: 1 | 0
} 
```



请求：一共两个参数，一个表示博客标题，一个表示博客正文

```http
POST /art/draft HTTP/1.1

{
	title:
	content:
}
```

响应：data数据 1表示成功，0表示失败

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: 1 | 0
} 
```


请求：一共三个参数，一个表示博客标题，一个表示博客正文，一个表示定时时间（2/30）表示2小时30分钟后

```http
POST /art/releasetime HTTP/1.1

{
	title:
	content:
	releaseTime:
}
```

响应：data数据 1表示成功，0表示失败

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: 1 | 0
} 
```



---

##### 博客修改接口

一共四个接口，分别为发布博客接口，保存为草稿接口，定时发布接口，进入修改页面在原内容上修改

请求：一共两个参数，一个表示博客标题，一个表示博客正文

```http
POST /art/update HTTP/1.1

{
	title:
	content:
}
```

响应：data数据 1表示成功，0表示失败

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: 1 | 0
} 
```


请求：一共两个参数，一个表示博客标题，一个表示博客正文

```http
POST /art/save HTTP/1.1

{
	title:
	content:
}
```

响应：data数据 1表示成功，0表示失败

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: 1 | 0
} 
```


请求：一共三个参数，一个表示博客标题，一个表示博客正文，一个表示定时时间

```http
POST /art/releasetime HTTP/1.1

{
	title:
	content:
	releaseTime:
}
```

响应：data数据 1表示成功，0表示失败

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: 1 | 0
} 
```


请求：一个参数，在那个博客的基础上进行修改

```http
POST /art/detail HTTP/1.1

{
	id:
}
```

响应：data数据 表示那个博客的详情，包括标题，正文，渲染到页面上进行修改

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: Articleinfo
} 
```


##### 博客详情接口

请求：

```http
POST /art/detail HTTP/1.1

{
	id:
}
```

响应：data数据 表示那个博客的详情，包括标题，正文，渲染到页面上进行修改

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: Articleinfo
} 
```



---

#### 服务端开发

##### 控制层

```java
package com.example.mycnblog.controller;

import com.example.mycnblog.common.AjaxResult;
import com.example.mycnblog.common.UserSessionUtils;
import com.example.mycnblog.entity.Articleinfo;
import com.example.mycnblog.entity.Userinfo;
import com.example.mycnblog.service.ArticleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import javax.servlet.http.HttpServletRequest;
import java.util.HashMap;
import java.util.List;

@ResponseBody
@RequestMapping("/art")
@Controller
public class ArticleController {

    @Autowired
    private ArticleService articleService;

    @RequestMapping("/mylist")
    public AjaxResult getArticleList(HttpServletRequest request) {
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        List<Articleinfo> list = articleService.getMyListService(userinfo.getId());
        return AjaxResult.success(list);
    }

    @RequestMapping("/delete")
    public AjaxResult deleteArticle(HttpServletRequest request, @RequestParam("id") Integer id) {
        if (id == null || id <= 0) {
            return AjaxResult.fail(0, "参数错误");
        }
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        int row = articleService.deleteArticleService(id, userinfo.getId());
        return AjaxResult.success(row);
    }

    @RequestMapping("/detail")
    public AjaxResult articleDetail(@RequestParam("id") Integer id) {
        if (id == null || id <= 0) {
            return AjaxResult.fail(0, "参数错误");
        }
        Articleinfo articleinfo = articleService.getArticleDetailService(id);
        return AjaxResult.success(articleinfo);
    }

    @RequestMapping("/uprcount")
    public AjaxResult incrementRCount(@RequestParam("id") Integer id) {
        if (id == null || id <= 0) {
            return AjaxResult.fail(0, "参数错误");
        }
        int row = articleService.incrementRCountService(id);
        return AjaxResult.success(row);
    }

    @RequestMapping("/add")
    public AjaxResult insertArt(Articleinfo articleinfo, HttpServletRequest request) {
        if (articleinfo == null || !StringUtils.hasLength(articleinfo.getTitle()) ||
                !StringUtils.hasLength(articleinfo.getContent())) {
            return AjaxResult.fail(0, "参数错误");
        }
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null || userinfo.getId() <= 0) {
            return AjaxResult.fail(-1, "非法访问");
        }
        articleinfo.setUid(userinfo.getId());
        int row = articleService.insertArticleService(articleinfo);
        return AjaxResult.success(row);
    }

    @RequestMapping("/draft")
    public AjaxResult draftSave(Articleinfo articleinfo, HttpServletRequest request) {
        if (articleinfo == null || (!StringUtils.hasLength(articleinfo.getTitle()) &&
                !StringUtils.hasLength(articleinfo.getContent()))) {
            return AjaxResult.fail(0, "参数错误");
        }
        // 设置草稿所属作者
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null || userinfo.getId() <= 0) {
            return AjaxResult.fail(-1, "非法访问");
        }
        articleinfo.setUid(userinfo.getId());
        articleinfo.setState(1);
        articleinfo.setUpdatetime(null);
        articleinfo.setCreatetime(null);
        int row = articleService.insertArticleService(articleinfo);
        return AjaxResult.success(row);
    }

    @RequestMapping("/update")
    public AjaxResult updateArt(Articleinfo articleinfo, HttpServletRequest request) {
        if (articleinfo == null || !StringUtils.hasLength(articleinfo.getTitle())
                || !StringUtils.hasLength(articleinfo.getContent()) || articleinfo.getId() <= 0) {
            return AjaxResult.fail(0, "参数错误");
        }
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        int row = articleService.updateArticleService(articleinfo, userinfo);
        return AjaxResult.success(row);
    }

    @RequestMapping("/listpage")
    public AjaxResult getListPage(@RequestParam("pindex") Integer pindex, @RequestParam("psize") Integer psize) {
        // 1. 参数校正
        if (pindex == null || pindex == 0) {
            pindex = 1;
        }
        if (psize == null || psize <= 1) {
            psize = 2;
        }
        // 2. 计算跳过的博客数量
        int offsize = (pindex - 1) * psize;
        // 3. 得到博客列表返回
        List<Articleinfo> list = articleService.getListByPageService(psize, offsize);
        int totalCount = articleService.getArticleNumberService();
        double pcountdb = totalCount / (psize * 1.0);
        int pcount = (int) Math.ceil(pcountdb);
        HashMap<String, Object> map = new HashMap<>();
        map.put("list", list);
        map.put("pcount", pcount);
        return AjaxResult.success(map);
    }

    @RequestMapping("/draftlist")
    public AjaxResult getDraftList(HttpServletRequest request) {
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        List<Articleinfo> draftList = articleService.getDraftListService(userinfo.getId());
        return AjaxResult.success(draftList);
    }

    @RequestMapping("/save")
    public AjaxResult saveDraft(Articleinfo articleinfo, HttpServletRequest request) {
        if (articleinfo == null || !StringUtils.hasLength(articleinfo.getTitle())
                || !StringUtils.hasLength(articleinfo.getContent()) || articleinfo.getId() <= 0) {
            return AjaxResult.fail(0, "参数错误");
        }
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        int row = articleService.saveDraftService(articleinfo, userinfo);
        return AjaxResult.success(row);
    }

    // 增加页面和修改页面的定时博客借口分开
    @RequestMapping("/releasetime")
    public AjaxResult releaseTime(Articleinfo articleinfo, HttpServletRequest request, @RequestParam("releaseTime") String releaseTime) {
        if (articleinfo == null || releaseTime == null
                || !StringUtils.hasLength(articleinfo.getTitle())
                || !StringUtils.hasLength(articleinfo.getContent())) {
            return AjaxResult.fail(0, "参数错误");
        }
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        int row = articleService.insertArticleService(articleinfo, userinfo, releaseTime);
        return AjaxResult.success(row);
    }

    // timelist 展示该用户所有的定时发布的文章
    @RequestMapping("/timelist")
    public AjaxResult getTimeList(HttpServletRequest request) {
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        List<Articleinfo> timeList = articleService.getTimeArticleListService(userinfo);
        return AjaxResult.success(timeList);
    }

    // publishnow 立即发布当前的定时文章
    @RequestMapping("/publishnow")
    public AjaxResult publishNowArt(@RequestParam("id") Integer id, HttpServletRequest request) {
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        int row = articleService.publishNowService(id, userinfo);
        return AjaxResult.success(row);
    }

    @RequestMapping("/dellist")
    public AjaxResult getDelList(HttpServletRequest request) {
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        List<Articleinfo> delList = articleService.getDelArticleListService(userinfo);
        return AjaxResult.success(delList);
    }

    @RequestMapping("/deletetrue")
    public AjaxResult deleteTrue(@RequestParam("id") Integer id, HttpServletRequest request){
        if (id == null || id <= 0) {
            return AjaxResult.fail(0, "参数错误");
        }
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        int row = articleService.deleteTrueService(id, userinfo);
        return AjaxResult.success(row);
    }
}

```



---

##### 服务层

```java
package com.example.mycnblog.service;

import com.example.mycnblog.entity.Articleinfo;
import com.example.mycnblog.entity.Userinfo;
import com.example.mycnblog.mapper.ArticleMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;

@Service
public class ArticleService {

    @Autowired
    public ArticleMapper articleMapper;

    public int getArticleNumberService(Integer uid, Integer state) {
        return articleMapper.getArticleNumberByuid(uid, state);
    }

    public List<Articleinfo> getMyListService(Integer uid) {
        return articleMapper.getMyList(uid);
    }

    public int deleteArticleService(Integer id, Integer uid) {
        return articleMapper.updateToDel(id, uid);
    }

    public Articleinfo getArticleDetailService(Integer id) {
        return articleMapper.getArticleDetail(id);
    }

    public int incrementRCountService(Integer id) {
        return articleMapper.incrementRCount(id);
    }

    public int insertArticleService(Articleinfo articleinfo) {
        return articleMapper.insertArticle(articleinfo);
    }

    public int insertArticleService(Articleinfo articleinfo, Userinfo userinfo, String releaseTime) {
        // 得到前端传来的 2/30
        String[] releaseTimeList = releaseTime.split("/");
        // 计算成秒数
        long time = (Long.parseLong(releaseTimeList[0] )* 60 + Long.parseLong(releaseTimeList[1])) * 60;
        // 把秒数增加到当前时间，搞一个多线程来不断扫描是否达到时间，达到发布
        LocalDateTime currentTime = LocalDateTime.now();
        LocalDateTime ultimatelyTime = currentTime.plusSeconds(time);

        articleinfo.setUid(userinfo.getId());
        articleinfo.setState(2);
        articleinfo.setCreatetime(ultimatelyTime);
        articleinfo.setUpdatetime(ultimatelyTime);
        if (articleinfo.getId() > 0) {
            // 有效的文章id， 说明是从修改页面加载来的接口，那么久从原来的文章上修改
            return articleMapper.updateTimeArticle(articleinfo);
        }
        // 无效文章 说明是从增加页面加载的接口，插入一个记录
        return articleMapper.insertArticleTime(articleinfo);
    }

    // 发布
    public int updateArticleService(Articleinfo articleinfo, Userinfo userinfo) {
        articleinfo.setUid(userinfo.getId());
        articleinfo.setUpdatetime(LocalDateTime.now());
        if (articleinfo.getState() == 1) {
            articleinfo.setCreatetime(LocalDateTime.now());
        }
        articleinfo.setState(0);
        return articleMapper.updateArticle(articleinfo);
    }

    // 保存草稿
    public int saveDraftService(Articleinfo articleinfo, Userinfo userinfo) {
        articleinfo.setState(1);
        articleinfo.setUpdatetime(LocalDateTime.now());
        articleinfo.setUid(userinfo.getId());
        articleinfo.setRcount(1);
        return articleMapper.updateArticle(articleinfo);
    }

    public int publishTimeArticleService(Articleinfo articleinfo, Userinfo userinfo) {
        articleinfo.setState(0);
        articleinfo.setUid(userinfo.getId());
        return articleMapper.updateArticle(articleinfo);
    }

    public List<Articleinfo> getListByPageService(Integer psize, Integer offsize) {
        return articleMapper.getListByPage(psize, offsize);
    }

    public int getArticleNumberService() {
        return articleMapper.getArticleNumber();
    }

    public List<Articleinfo> getDraftListService(Integer uid) {
        return articleMapper.getDraftList(uid);
    }

    public void checkArticleTime() {
        List<Articleinfo> list = articleMapper.getTimeArticle();
        if (list == null || list.size() == 0) {
            return;
        }
        for (Articleinfo articleinfo : list) {
            if (articleinfo.getCreatetime().isBefore(LocalDateTime.now())) {
                int row = articleMapper.publishCheckTime(articleinfo.getId());
                // websocket 来主动通知用户定时发布文章成功
            }
        }
    }

    public List<Articleinfo> getTimeArticleListService(Userinfo userinfo) {
        return articleMapper.getTimeList(userinfo.getId());
    }

    public int publishNowService(Integer id, Userinfo userinfo) {
        return articleMapper.publishNowArticle(id, userinfo.getId());
    }

    public List<Articleinfo> getDelArticleListService(Userinfo userinfo) {
        return articleMapper.getDelList(userinfo.getId());
    }

    public int deleteTrueService(Integer id, Userinfo userinfo) {
        return articleMapper.deleteTrue(id, userinfo.getId());
    }

}
```

其中checkArticleTime()方法就是为了查找定时发布博客，看是否到大预定发布时间，到了就修改定时发布博客的状态（state=1）

要使该方法没隔一段你时间就调用检查，需要设置一个组件，代码如下：

```java
package com.example.mycnblog.component;

import com.example.mycnblog.service.ArticleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

@Component
@EnableScheduling
public class RegularCheck {

    @Autowired
    private ArticleService articleService;

    @Scheduled(cron = "0/3 * * * * ? ")
    public void RegularCheckArticleService() {
        articleService.checkArticleTime();
    }
}
```

代码含义就是每隔三秒就调用上面的代码，但是这种方法比较占服务器资源，但也是刚写项目实现其功能的一种手段



---

#### 客户端开发

在开发之前我们需要引入支持MarkDown语法的编辑器，还请读者从网上搜索答案，再次不再赘述

##### 发布博客列表页面

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客列表</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/blog_list.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/common.js"></script>
</head>

<body>
    <!-- 导航栏 -->
    <div class="nav">
        <img src="img/system.png" alt="">
        <span class="title">我的博客系统</span>
        <!-- 用来占据中间位置 -->
        <span class="spacer"></span>
        <a href="blog_list.html">主页</a>
        <a href="person.html">资料修改</a>
        <a href="draft_list.html">草稿</a>
        <a href="blog_time.html">定时博客</a>
        <a href="blog_already_delete.html">博客删除记录</a>
        <a href="blog_add.html">写博客</a>
        <a href="javascript: logout()">退出登录</a>
    </div>
    <!-- 版心 -->
    <div class="container">
        <!-- 左侧个人信息 -->
        <div class="container-left">
            <div class="card">
                <img src="img/doge.jpg" class="avtar" alt="">
                <h3 id="username"></h3>
                <a href="http:www.github.com">github 地址</a>
                <div class="counter">
                    <span>文章</span>
                    <span>分类</span>
                </div>
                <div class="counter">
                    <span id = "articleNumber"></span>
                    <span>1</span>
                </div>
            </div>
        </div>
        <!-- 右侧内容详情 -->
        <div id="artDiv" class="container-right">
            
            
        </div>
    </div>

    <script>
        function showInfo() {
            jQuery.ajax({
                url: '/user/showinfo',
                type: 'post',
                data: {"state": 0},
                success: function(result) {
                    if (result != null && result.statusCode == 200 && result.data != null) {
                        jQuery("#username").text(result.data.username);
                        jQuery("#articleNumber").text(result.data.articleNumber);
                    } else {
                        alert("个人信息加载失败，请刷新");
                    }
                }
            });
        }

        showInfo();

        function getMyArticleList(){
                jQuery.ajax({
                    url:"/art/mylist",
                    type:"POST",
                    data:{},
                    success:function(result){
                        if(result!=null && result.statusCode==200){
                           // 有两种情况，一种是发表了文章，一种是没有发表任何文章 
                           if(result.data!=null && result.data.length>0){
                            // 此用户发表文章了
                            var artListDiv ="";
                            for(var i=0;i<result.data.length;i++){
                                var artItem = result.data[i];
                                artListDiv += '<div class="blog">';
                                artListDiv += '<div class="title">'+artItem.title+'</div>';
                                artListDiv += '<div class="date">'+artItem.updatetime+'</div>';
                                artListDiv += '<div class="desc">';
                                artListDiv += artItem.content;
                                artListDiv += '</div>';
                                artListDiv += '<a href="blog_content.html?id='+
                                    artItem.id + '" class="detail">查看全文 &gt;&gt;</a>&nbsp;&nbsp;';
                                artListDiv += '<a href="blog_edit.html?id='+
                                    artItem.id + '" class="detail">修改 &gt;&gt;</a>&nbsp;&nbsp;';  
                                artListDiv += '<a href="javascript:myDel('+
                                    artItem.id+');" class="detail">删除 &gt;&gt;</a>'; 
                                artListDiv += '</div>';    
                            }
                            jQuery("#artDiv").html(artListDiv);
                           }else{
                            // 当前用户从未发过任何文章
                            jQuery("#artDiv").html("<h3>暂无文章~</h3>");    
                           }
                        }else{
                            alert("查询文章列表出错，请重试！");
                        }
                    }
                });
        }

        getMyArticleList();

        function myDel(id) {
            if (confirm("确认删除改文章？")) {
                // 删除文章
                jQuery.ajax({
                    url: '/art/delete',
                    type: 'post',
                    data: {"id": id},
                    success: function(result) {
                        if (result != null && result.statusCode == 200 && result.data == 1) {
                            location.href = location.href;
                            alert("删除成功");
                        } else {
                            alert("删除失败，请重试");
                        }
                    }

                });
            }
        }

        
    </script>
</body>

</html>
```

列表页面CSS：

```css
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* 设置整体页面高度 */
html, body {
    height: 100%;
    /* background-image: url(../img/cat.jpg); */
    background-image: linear-gradient(120deg, #d4fc79 0%, #96e6a1 100%);
    background-position: center center;
    background-size: cover;
    background-repeat: repeat-y;
}

/* 上方导航栏 */
.nav {
    width: 100%;
    height: 50px;
    background-color: rgba(51, 51, 51, 0.4);
    color: #fff;

    display: flex;
    justify-content: left;
    align-items: center;
    justify-content: space-between;
}

/* 导航栏中的图标 */
.nav img {
    width: 40px;
    height: 40px;
    margin-left: 30px;
    margin-right: 10px;
    border-radius: 50%;
}

/* 导航栏中的占位器 */
.nav .spacer {
    width: 70%;
}

/* 导航栏中的按钮 */
.nav a {
    color: #fff;
    text-decoration: none;
    padding: 0 10px;
}

/* 页面内容容器, 版心 */
.container {
    /* 使用 calc 计算高度 */
    height: calc(100% - 50px);
    /* 设置版心宽度 */
    width: 1000px;
    /* 水平居中 */
    margin: 0 auto;
    /* 使用弹性布局 */
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* 左侧部分, 用来放置用户信息 */
.container-left {
    height: 100%;
    width: 200px;
}

/* 右侧部分, 用来放置正文 */
.container-right {
    height: 100%;
    /* 和左侧部分中间留出 5px 间隙 */
    width: 795px;
    /* 如果内容溢出就自动加上滚动条 */
    overflow: auto;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
}

/* 展示用户信息的卡片 */
.card {
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    padding: 30px;
}

/* 用户头像 */
.card img {
    width: 140px;
    height: 140px;
    border-radius: 50%;
}

/* 用户名 */
.card h3 {
    text-align: center;
    padding: 10px;
}

/* 用户 github 链接 */
.card a {
    display: block;
    text-align: center;
    color: #999;
    text-decoration: none;
    padding: 10px;
}

/* 展示文章数目的面板 */
.card .counter {
    padding: 5px;
    display: flex;
    justify-content: space-around;
}
```



---

##### 博客草稿列表页面

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>草稿列表</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/blog_list.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/common.js"></script>
</head>
<!-- 
    草稿列表页面
 -->
<body>
    <!-- 导航栏 -->
    <div class="nav">
        <img src="img/system.png" alt="">
        <span class="title">我的博客系统</span>
        <!-- 用来占据中间位置 -->
        <span class="spacer"></span>
        <a href="blog_list.html">主页</a>
        <a href="myblog_list.html">个人博客列表</a>
        <a href="blog_add.html">写博客</a>
        <a href="javascript: logout()">退出登录</a>
    </div>
    <!-- 版心 -->
    <div class="container">
        <!-- 左侧个人信息 -->
        <div class="container-left">
            <div class="card">
                <img src="img/doge.jpg" class="avtar" alt="">
                <h3 id="username"></h3>
                <a href="http:www.github.com">github 地址</a>
                <div class="counter">
                    <span>文章</span>
                    <span>分类</span>
                </div>
                <div class="counter">
                    <span id = "articleNumber"></span>
                    <span>1</span>
                </div>
            </div>
        </div>
        <!-- 右侧内容详情 -->
        <div id="artDiv" class="container-right">
            
            
        </div>
    </div>

    <script>
        function showInfo() {
            jQuery.ajax({
                url: '/user/showinfo',
                type: 'post',
                data: {"state": 1},
                success: function(result) {
                    if (result != null && result.statusCode == 200) {
                        jQuery("#username").text(result.data.username);
                        jQuery("#articleNumber").text(result.data.articleNumber);
                    } else {
                        alert("个人信息加载失败，请刷新");
                    }
                }
            });
        }

        showInfo();

        function getMyArticleList(){
                jQuery.ajax({
                    url:'/art/draftlist',
                    type:'POST',
                    data:{},
                    success:function(result){
                        if(result!=null && result.statusCode==200){
                           // 有两种情况，一种是发表了文章，一种是没有发表任何文章 
                           if(result.data!=null && result.data.length>0){
                                // 此用户发表文章了
                                var artListDiv ="";
                                for(var i=0;i<result.data.length;i++){
                                    var artItem = result.data[i];
                                    artListDiv += '<div class="blog">';
                                    artListDiv += '<div class="title">'+artItem.title+'</div>';
                                    artListDiv += '<div class="date">'+artItem.updatetime+'</div>';
                                    artListDiv += '<div class="desc">';
                                    artListDiv += artItem.content;
                                    artListDiv += '</div>';
                                    artListDiv += '<a href="blog_edit.html?id='+
                                        artItem.id + '" class="detail">修改 &gt;&gt;</a>&nbsp;&nbsp;';  
                                    artListDiv += '<a href="javascript:myDel('+
                                        artItem.id+');" class="detail">删除 &gt;&gt;</a>'; 
                                    artListDiv += '</div>';    
                                }
                                jQuery("#artDiv").html(artListDiv);
                           }else{
                                // 当前用户从未发过任何文章
                                jQuery("#artDiv").html("<h3>暂无草稿~</h3>");    
                           }
                        }else{
                            alert("查询文章列表出错，请重试！");
                        }
                    }
                });
        }

        getMyArticleList();

        function myDel(id) {
            if (confirm("确认删除草稿？")) {
                // 删除草稿
                jQuery.ajax({
                    url: '/art/delete',
                    type: 'post',
                    data: {"id": id},
                    success: function(result) {
                        if (result != null && result.statusCode == 200 && result.data == 1) {
                            location.href = location.href;
                            alert("删除成功");
                        } else {
                            alert("删除失败，请重试");
                        }
                    }

                });
            }
        }

        
    </script>
</body>

</html>
```



---

##### 定时博客列表页面

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定时博客列表</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/blog_list.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/common.js"></script>
</head>
<body>
    <!-- 导航栏 -->
    <div class="nav">
        <img src="img/system.png" alt="">
        <span class="title">我的博客系统</span>
        <!-- 用来占据中间位置 -->
        <span class="spacer"></span>
        <a href="blog_list.html">主页</a>
        <a href="myblog_list.html">个人博客列表</a>
        <a href="blog_add.html">写博客</a>
        <a href="javascript: logout()">退出登录</a>
    </div>
    <!-- 版心 -->
    <div class="container">
        <!-- 左侧个人信息 -->
        <div class="container-left">
            <div class="card">
                <img src="img/doge.jpg" class="avtar" alt="">
                <h3 id="username"></h3>
                <a href="http:www.github.com">github 地址</a>
                <div class="counter">
                    <span>文章</span>
                    <span>分类</span>
                </div>
                <div class="counter">
                    <span id = "articleNumber"></span>
                    <span>1</span>
                </div>
            </div>
        </div>
        <!-- 右侧内容详情 -->
        <div id="artDiv" class="container-right">
            
            
        </div>
    </div>

    <script>
        function showInfo() {
            jQuery.ajax({
                url: '/user/showinfo',
                type: 'post',
                data: {"state": 2},
                success: function(result) {
                    if (result != null && result.statusCode == 200) {
                        jQuery("#username").text(result.data.username);
                        jQuery("#articleNumber").text(result.data.articleNumber);
                    } else {
                        alert("个人信息加载失败，请刷新");
                    }
                }
            });
        }

        showInfo();

        function getMyArticleList(){
                jQuery.ajax({
                    url:'/art/timelist',
                    type:'POST',
                    data:{},
                    success:function(result){
                        if(result!=null && result.statusCode==200){
                           // 有两种情况，一种是发表了文章，一种是没有发表任何文章 
                           if(result.data!=null && result.data.length>0){
                                // 此用户发表文章了
                                var artListDiv ="";
                                for(var i=0;i<result.data.length;i++){
                                    var artItem = result.data[i];
                                    artListDiv += '<div class="blog">';
                                    artListDiv += '<div class="title">'+artItem.title+'</div>';
                                    artListDiv += '<div class="date">'+artItem.updatetime+'</div>';
                                    artListDiv += '<div class="desc">';
                                    artListDiv += artItem.content;
                                    artListDiv += '</div>';
                                    artListDiv += '<a href="blog_edit.html?id='+
                                        artItem.id + '" class="detail">修改 &gt;&gt;</a>&nbsp;&nbsp;';  
                                    artListDiv += '<a href="javascript:publishNow('+
                                        artItem.id+');" class="detail">立即发布 &gt;&gt;</a>&nbsp;&nbsp;'; 
                                    artListDiv += '<a href="javascript:myDel('+
                                        artItem.id+');" class="detail">删除 &gt;&gt;</a>'; 
                                    artListDiv += '</div>';    
                                }
                                jQuery("#artDiv").html(artListDiv);
                           }else{
                                // 当前用户从未发过任何文章
                                jQuery("#artDiv").html("<h3>暂无定时发布的文章~</h3>");    
                           }
                        }else{
                            alert("查询文章列表出错，请重试！");
                        }
                    }
                });
        }

        getMyArticleList();

        function publishNow(id) {

            if (confirm("是否立即发布？")) {
                jQuery.ajax({
                    url: '/art/publishnow',
                    type: 'post',
                    data: {"id": id},
                    success: function(result) {
                        if (result != null && result.statusCode == 200 && result.data == 1) {
                            alert("立即发布成功！");
                            location.href = location.href;
                        } else {
                            alert("发布失败！请重试");
                        }
                    }
                });
            }
        }

        function myDel(id) {
            if (confirm("确认删除改定时发布文章？")) {
                // 删除草稿
                jQuery.ajax({
                    url: '/art/delete',
                    type: 'post',
                    data: {"id": id},
                    success: function(result) {
                        if (result != null && result.statusCode == 200 && result.data == 1) {
                            location.href = location.href;
                            alert("删除成功");
                            location.href = location.href;
                        } else {
                            alert("删除失败，请重试");
                        }
                    }

                });
            }
        }

        
    </script>
</body>

</html>
```



---

##### 已删除的博客列表页面

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客列表</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/blog_list.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/common.js"></script>
</head>

<body>
<!-- 导航栏 -->
<div class="nav">
    <img src="img/system.png" alt="">
    <span class="title">我的博客系统</span>
    <!-- 用来占据中间位置 -->
    <span class="spacer"></span>
    <a href="blog_list.html">主页</a>
    <a href="myblog_list.html">个人博客列表</a>
    <a href="blog_add.html">写博客</a>
    <a href="javascript: logout()">退出登录</a>
</div>
<!-- 版心 -->
<div class="container">
    <!-- 左侧个人信息 -->
    <div class="container-left">
        <div class="card">
            <img src="img/doge.jpg" class="avtar" alt="">
            <h3 id="username"></h3>
            <a href="http:www.github.com">github 地址</a>
            <div class="counter">
                <span>文章</span>
                <span>分类</span>
            </div>
            <div class="counter">
                <span id = "articleNumber"></span>
                <span>1</span>
            </div>
        </div>
    </div>
    <!-- 右侧内容详情 -->
    <div id="artDiv" class="container-right">


    </div>
</div>

<script>
    function showInfo() {
        jQuery.ajax({
            url: '/user/showinfo',
            type: 'post',
            data: {"state": 3},
            success: function(result) {
                if (result != null && result.statusCode == 200) {
                    jQuery("#username").text(result.data.username);
                    jQuery("#articleNumber").text(result.data.articleNumber);
                } else {
                    alert("个人信息加载失败，请刷新");
                }
            }
        });
    }

    showInfo();

    function getMyArticleList(){
        jQuery.ajax({
            url:"/art/dellist",
            type:"POST",
            data:{},
            success:function(result){
                if(result!=null && result.statusCode==200){
                    // 有两种情况，一种是发表了文章，一种是没有发表任何文章
                    if(result.data!=null && result.data.length>0){
                        // 此用户发表文章了
                        var artListDiv ="";
                        for(var i=0;i<result.data.length;i++){
                            var artItem = result.data[i];
                            artListDiv += '<div class="blog">';
                            artListDiv += '<div class="title">'+artItem.title+'</div>';
                            artListDiv += '<div class="date">'+artItem.updatetime+'</div>';
                            artListDiv += '<div class="desc">';
                            artListDiv += artItem.content;
                            artListDiv += '</div>';
                            artListDiv += '<a href="blog_edit.html?id='+
                                artItem.id + '" class="detail">修改 &gt;&gt;</a>&nbsp;&nbsp;';
                            artListDiv += '<a href="javascript:myDel('+
                                artItem.id+');" class="detail">删除 &gt;&gt;</a>';
                            artListDiv += '</div>';
                        }
                        jQuery("#artDiv").html(artListDiv);
                    }else{
                        // 当前用户从未发过任何文章
                        jQuery("#artDiv").html("<h3>暂无删除的文章~</h3>");
                    }
                }else{
                    alert("查询文章列表出错，请重试！");
                }
            }
        });
    }

    getMyArticleList();

    function myDel(id) {
        if (confirm("确认永久删除改文章？")) {
            // 删除文章
            jQuery.ajax({
                url: '/art/deletetrue',
                type: 'post',
                data: {"id": id},
                success: function(result) {
                    if (result != null && result.statusCode == 200 && result.data == 1) {
                        location.href = location.href;
                        alert("删除成功");
                    } else {
                        alert("删除失败，请重试");
                    }
                }

            });
        }
    }


</script>
</body>

</html>
```



---

##### 博客添加页面

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添加博客</title>

    <!-- 引入自己写的样式 -->
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/blog_edit.css">

    <!-- 引入 editor.md 的依赖 -->
    <link rel="stylesheet" href="editor.md/css/editormd.min.css" />
    <script src="js/jquery.min.js"></script>
    <script src="editor.md/editormd.js"></script>
    <script src="js/common.js"></script>
</head>

<body>
    <!-- 导航栏 -->
    <div class="nav">
        <img src="img/system.png" alt="">
        <span class="title">我的博客系统</span>
        <!-- 用来占据中间位置 -->
        <span class="spacer"></span>
        <a href="blog_list.html">主页</a>
        <a href="myblog_list.html">博客列表</a>
        <a href="person.html">资料修改</a>
        <a href="javascript: logout()">退出登录</a>
    </div>
    <!-- 编辑框容器 -->
    <div class="blog-edit-container">
        <!-- 标题编辑区 -->
        <div class="title">
            <input type="text" id="title" placeholder="在这里写下文章标题"><label for="title">&nbsp&nbsp</label>
            <button onclick="draft()">保存草稿</button>&nbsp&nbsp
            <button onclick="time()">定时发布</button>&nbsp&nbsp
            <label for="releasetime">&nbsp&nbsp</label><input type="text" id="releasetime" style="width: 420px;" placeholder="格式如:2/30表示两小时三十分钟后发布">&nbsp&nbsp
            <button onclick="mysub()">发布文章</button>
        </div>
        <!-- 创建编辑器标签 -->
        <div id="editorDiv">
            <label for="editor-markdown"></label><textarea id="editor-markdown" style="display:none;"></textarea>
        </div>
    </div>

    <script>
        let editor;

        function initEdit(md){
            // 编辑器设置
            editor = editormd("editorDiv", {
                // 这里的尺寸必须在这里设置. 设置样式会被 editormd 自动覆盖掉. 
                width: "100%",
                // 高度 100% 意思是和父元素一样高. 要在父元素的基础上去掉标题编辑区的高度
                height: "calc(100% - 50px)",
                // 编辑器中的初始内容
                markdown: md,
                // 指定 editor.md 依赖的插件路径
                path: "editor.md/lib/",
                saveHTMLToTextarea: true // 
            });
        }
        initEdit("# 在这里写下一篇博客"); // 初始化编译器的值

        function time() {

            if (confirm("是否定时发布？")) {
                let releasetime = jQuery("#releasetime");
                let title = jQuery("#title");

                if (title.val() === "") {
                    alert("请输入标题");
                    return;
                }   
                if (editor.getValue() === "") {
                    alert("请输入文章内容");
                    return;
                }
                if (releasetime.val() === "") {
                    alert("请输入定时发布时间");
                    return;
                }

                jQuery.ajax({
                    url: '/art/releasetime',
                    type: 'post',
                    data: {"title":  title.val(), "content": editor.getValue(), "releaseTime": releasetime.val()},
                    success: function(result) {
                        if (result != null && result.statusCode === 200 && result.data === 1) {
                            alert("定时发布成攻");
                            location.href = "blog_time.html";
                        } else {
                            alert("定时发布失败，请重试！");
                        }
                    }
                });
            }
        }

        function draft() {

            if (confirm("是否保存为草稿？")) {
                let title = jQuery("#title");

                jQuery.ajax({
                    url: '/art/draft',
                    type: 'post',
                    data: {"title": title.val(), "content": editor.getValue()},
                    success: function(result) {
                        if (result != null && result.statusCode === 200 && result.data === 1) {
                            alert("保存成功！");
                            location.href = "draftblog.html";
                        } else {
                            alert("保存失败，请重试");
                        }
                    }
                });
            }
        }

        // 提交
        function mysub(){
            // alert(editor.getValue()); // 获取值
            // editor.setValue("#123") // 设置值
            if (confirm("确认提交？")) {
                let title = jQuery("#title");
                if (title.val() === "") {
                    alert("请输入标题");
                    return;
                }
                if (editor.getValue() === "") {
                    alert("请输入文章正文");
                    return;
                }
                jQuery.ajax({
                    url: '/art/add',
                    type: 'post',
                    data: {"title": title.val(), "content": editor.getValue()},
                    success: function(result) {
                        if (result != null && result.statusCode === 200 && result.data === 1) {
                            if (confirm("添加成功，是否继续添加？")) {
                                location.href = location.href;
                            } else {
                                location.href = "/myblog_list.html";
                            }
                        } else {
                            alert("添加失败，请重试")
                        }
                    }
                });
            }
        }
    </script>
</body>

</html>
```



博客添加页面和博客修改页面的CSS：

```css
.blog-edit-container {
    width: 1000px;
    height: calc(100% - 50px);
    margin: 0 auto;
}

.blog-edit-container .title {
    width: 100%;
    height: 50px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.blog-edit-container .title input {
    height: 40px;
    width: 890px;
    text-indent: 10px;
    border-radius: 10px;
    outline: none;
    border: none;
    background-color:rgba(255, 255, 255, 0.8);
}

.blog-edit-container .title button {
    height: 40px;
    width: 100px;

    color: white;
    background-color: orange;
    border: none;
    outline: none;
    border-radius: 10px;
}

#editor {
    border-radius: 10px;
    /* 针对 #editor 用 bgc 属性无法设置半透明了. 里面包含的内容带了背景色 */
    /* background-color:rgba(255, 255, 255, 0.8); */
    /* 可以使用 opacity 属性实现 */
    opacity: 80%;
}
```



---

##### 博客修改页面

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客编辑</title>

    <!-- 引入自己写的样式 -->
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/blog_edit.css">

    <!-- 引入 editor.md 的依赖 -->
    <link rel="stylesheet" href="editor.md/css/editormd.min.css" />
    <script src="js/jquery.min.js"></script>
    <script src="editor.md/editormd.js"></script>
    <script src="js/common.js"></script>
</head>

<body>
    <!-- 导航栏 -->
    <div class="nav">
        <img src="img/system.png">
        <span class="title">我的博客系统</span>
        <!-- 用来占据中间位置 -->
        <span class="spacer"></span>
        <a href="blog_list.html">主页</a>
        <a href="person.html">资料修改</a>
        <a href="javascript: logout()">退出登录</a>
    </div>
    <!-- 编辑框容器 -->
    <div class="blog-edit-container">
        <!-- 标题编辑区 -->
        <div class="title">
            <input type="text" id="title" placeholder="在这里写下文章标题">&nbsp&nbsp
            <button onclick="save()">保存草稿</button>&nbsp&nbsp
            <button onclick="time()">定时发布</button>&nbsp&nbsp
            <input type="text" id="releasetime" style="width: 420px;" placeholder="格式如:2/30表示两小时三十分钟后发布">&nbsp&nbsp
            <button onclick="mysub()">发布文章</button>
        </div>
        <!-- 创建编辑器标签 -->
        <div id="editorDiv">
            <textarea id="editor-markdown" style="display:none;"></textarea>
        </div>
    </div>

    <script>
        var editor;
        var id = "";

        function initEdit(md){
            // 编辑器设置
            editor = editormd("editorDiv", {
                // 这里的尺寸必须在这里设置. 设置样式会被 editormd 自动覆盖掉. 
                width: "100%",
                // 高度 100% 意思是和父元素一样高. 要在父元素的基础上去掉标题编辑区的高度
                height: "calc(100% - 50px)",
                // 编辑器中的初始内容
                markdown: md,
                // 指定 editor.md 依赖的插件路径
                path: "editor.md/lib/",
                saveHTMLToTextarea: true // 
            });
        }

        // 定时发布
        function time() {
            
            var releasetime = jQuery("#releasetime");
            var title = jQuery("#title");

            if (title.val() == "") {
                alert("请输入标题");
                return;
            }
            
            if (editor.getValue() == "") {
                alert("请输入文章内容");
                return;
            }
            if (releasetime.val() == "") {
                alert("请输入定时发布时间");
                return;
            }

            jQuery.ajax({
                url: '/art/releasetime',
                type: 'post',
                data: {"id": id, "title":  title.val(), "content": editor.getValue(), "releaseTime": releasetime.val()},
                success: function(result) {
                    if (result != null && result.statusCode == 200 && result.data == 1) {
                        alert("定时发布成功");
                        location.href = "blog_time.html";
                    } else {
                        alert("定时发布失败，请重试！");
                    }
                }
            });
        }

        // 保存草稿
        function save() {

            var title = jQuery("#title") 

            if(confirm("是否修改草稿？")) {
                jQuery.ajax({
                    url: '/art/save',
                    type: 'post',
                    data: {"id": id, "title": title.val(), "content": editor.getValue()},
                    success: function(result) {
                        if (result != null && result.statusCode == 200 && result.data == 1) {
                            alert("保存草稿成功");
                            location.href = location.href;
                        } else {
                            alert("保存失败，请重试");
                        }
                    }
                });
            }
        }

        // 发布
        function mysub(){
            // 非空效验
            var title = jQuery("#title") 
            if (title.val == "") {
                alert("请输入文章标题");
                return;
            }
            if (editor.getValue() == "") {
                alert("请输入文章正文");
            }
            if (confirm("是否确认发布？")) {
                jQuery.ajax({
                    url: '/art/update',
                    type: 'post',
                    data: {"id": id, "title": title.val(), "content": editor.getValue()},
                    success: function(result) {
                        if (result != null && result.statusCode == 200 && result.data == 1) {
                            alert("发布成功");
                            location.href = "/myblog_list.html";
                        } else {
                            alert("发布失败，请重试！");
                        }
                    }
                });
            }
        }

        function initArticle() {
            id = getUrlValue("id");
            if (id == "") {
                alert("无效参数");
                location.href = "/myblog_list.html";
                return;
            }
            jQuery.ajax({
                    url: '/art/detail',
                    type: 'post',
                    data: {"id": id},
                    success: function(result) {
                        if (result != null && result.statusCode == 200) {
                            jQuery("#title").val(result.data.title);
                            initEdit(result.data.content);
                        } else {
                            alert("查询失败，请重试");
                        }
                    }
                });
        }

        initArticle();

    </script>
</body>

</html>
```



---

##### 博客正文页面

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客正文</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/blog_content.css">
    <link rel="stylesheet" href="editor.md/css/editormd.preview.min.css"/>
    <script src="js/jquery.min.js"></script>
    <script src="editor.md/editormd.js"></script>
    <script src="editor.md/lib/marked.min.js"></script>
    <script src="editor.md/lib/prettify.min.js"></script>
    <script src="js/common.js"></script>
</head>

<body>
<!-- 导航栏 -->
<div class="nav">
    <img src="img/system.png" alt="">
    <span class="title">我的博客系统</span>
    <!-- 用来占据中间位置 -->
    <span class="spacer"></span>
    <a href="blog_list.html">主页</a>
    <a href="myblog_list.html">博客列表</a>
    <a href="blog_edit.html">写博客</a>
    <a href="javascript: logout()">退出登录</a>
</div>
<!-- 版心 -->
<div class="container">
    <!-- 左侧个人信息 -->
    <div class="container-left">
        <div class="card">
            <img src="img/doge.jpg" class="avtar" alt="">
            <h3 id="username"></h3>
            <a href="https://:www.github.com">github 地址</a>
            <div class="counter">
                <span>文章</span>
                <span>分类</span>
            </div>
            <div class="counter">
                <span id="articleNumber"></span>
                <span>1</span>
            </div>
        </div>
    </div>
    <!-- 右侧内容详情 -->
    <div class="container-right">
        <div class="blog-content">
            <!-- 博客标题 -->
            <h3 id="title"></h3>
            <!-- 博客时间 -->
            <div class="date">
                发布时间：<span id="updatetime"></span>&nbsp;
                阅读量：<span id="rcount"></span>
            </div>

            <!-- 博客正文 -->
            <div id="editorDiv">

            </div>
        </div>
        <div class="blog-comment">
            <div>
                <h3>评论区</h3>
                <br>
                <hr>
                <br>
            </div>
            <div class="fun">
                <span class="comment-tying"><label for="typing"></label><textarea id="typing" placeholder="请写下你的评论"></textarea></span>&nbsp;&nbsp;
                <span class="comment-button"><button id="btn" onclick="send()">发送评论</button></span>
            </div>
            <br>
            <div id="comment">

            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var editormd;

    function initEdit(md) {
        editormd = editormd.markdownToHTML("editorDiv", {
            markdown: md, // Also, you can dynamic set Markdown text
            // htmlDecode : true,  // Enable / disable HTML tag encode.
            // htmlDecode : "style,script,iframe",  // Note: If enabled, you should filter some dangerous HTML tags for website security.
        });
    }

    function getArticleDetail(id) {
        jQuery.ajax({
            url: '/art/detail',
            type: 'post',
            data: {"id": id},
            success: function (result) {
                if (result != null && result.statusCode == 200) {
                    jQuery("#title").html(result.data.title);
                    jQuery("#updatetime").html(result.data.updatetime);
                    jQuery("#rcount").html(result.data.rcount);
                    initEdit(result.data.content);
                    // 得到作者详细信息
                    showUser(result.data.uid);
                    // 得到这篇博客的评论
                    showComment(id);
                    // 每得到信息是都更新rcount
                    updataRCount();
                } else {
                    alert("查询失败，请重试");
                }
            }
        });
    }

    getArticleDetail(getUrlValue("id"));

    function showUser(id) {
        jQuery.ajax({
            url: '/user/showauthor',
            type: 'post',
            data: {"id": id},
            success: function (result) {
                if (result != null && result.statusCode == 200 && result.data.articleNumber > 0) {
                    jQuery("#username").text(result.data.username);
                    jQuery("#articleNumber").text(result.data.articleNumber);
                } else {
                    alert("作者查询失败，请重试");
                }
            }
        });
    }

    function updataRCount() {
        var id = getUrlValue("id");
        if (id != "") {
            jQuery.ajax({
                url: '/art/uprcount',
                type: 'post',
                data: {"id": id},
                success: function (result) {
                }
            });
        }
    }

</script>
</body>

</html>
```

博客正文页面的CSS：

```css
/* 博客正文容器 */
.blog-content {
    padding: 30px;
}

/* 博客标题 */
.blog-content h3 {
    text-align: center;
    padding: 20px 0;
}

/* 博客日期 */
.blog-content .date {
    color: #008000;
    padding: 10px 0;
    text-align: center;
}

/* 博客内容段落 */
.blog-content p {
    text-indent: 2em;
    padding: 10px 0;
}

.blog-comment .fun{
    display: flex;
}

/* 评论标题 */
.blog-comment h3 {
    text-align: center;
}

.blog-comment #typing {
    flex: 1;
    width: 60%;
    height: 8vh;
    border: red;
    font-size:xx-large;
}

.blog-comment #comment{
    flex: 1;
    width: 80%;
}

.blog-comment #btn{
    width: 150px;
    height: 70px;
    border: none;
    border-radius: 10px;
    background-image: linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%);
}

.para {
    background-image: linear-gradient(to top, #fad0c4 0%, #fad0c4 1%, #ffd1ff 100%);
}

.blog-comment .comment-button {
    align-items: center;
}
```



---

### 实现其他（评论）模块

#### 编写数据库代码

##### 数据库设计

需要5个参数：

id 表示该评论的唯一标识（自增主键），content 表示评论的内容，createtime表示评论创建时间

articleid 表示该评论所属的发布博客，uid 表示该评论所属用户

```mysql
create database if not exists mycnblog;

use mycnblog;

drop table if exists commentinfo;

create table if not exists commentinfo (
  id int(11) not null auto_increment primary key,
  content varchar(50) not null,
  create_time datetime not null default current_timestamp,
  articleid int(11) not null,
  uid int(11) not null,
) engine=innodb auto_increment=4 default charset=utf8mb4

insert into commentinfo(content, articleid, uid) values('文章写的很好', 1, 1);
insert into commentinfo(content, articleid, uid ) values('有一个问题，是。。', 1, 1);
```



---

##### 创建entity.commentinfo实体类

```java
package com.example.mycnblog.entity;

import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

@Data
public class Commentinfo implements Serializable {
    private Integer id;
    private String content;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private LocalDateTime createtime;
    private Integer articleid;
    private Integer uid;
}

```



---

##### 创建mapper.commentinfoMapper接口

```java
package com.example.mycnblog.mapper;

import com.example.mycnblog.entity.Commentinfo;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;

@Mapper
public interface CommentMapper {

    /**
     * 添加评论，在哪一篇博客，哪个人发布都
     * @param commentinfo 评论详情
     * @return 返回受影响的行数
     */
    int insertComment(Commentinfo commentinfo);

    /**
     * 根据文章id查询评论，进入文章详情时，就要展示在该博客下的评论
     * @param articleId 文章id
     * @return 评论的列表
     */
    List<Commentinfo> selectComments(@Param("articleId") Integer articleId);

    /**
     * 根据用户id查询用户名，每个评论要标识谁发的评论
     * @param userId 用户id
     * @return 用户名
     */
    String selectUsernameByUid(@Param("userId") Integer userId);
}
```



---

##### 实现commentinfoMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mycnblog.mapper.CommentMapper">

    <insert id="insertComment">
        insert into commentinfo(content, articleid, uid) values (#{content}, #{articleid}, #{uid})
    </insert>

    <select id="selectComments" resultType="com.example.mycnblog.entity.Commentinfo">
        select * from commentinfo where articleid = #{articleId}
    </select>

    <select id="selectUsernameByUid" resultType="java.lang.String">
        select username from userinfo where id = #{userId};
    </select>
    
</mapper>
```



#### 前后端接口

##### 发布评论接口

请求：两个参数，一个是评论正文，一个是文章id，评论所属人根据session设置

```http
POST /comment/add HTTP/1.1

{
	content:
	articleid:
}
```

响应：data数据 1表示成功，0表示失败

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: 1 | 0
} 
```



---

##### 查找评论接口

请求：一个参数，表示当前博客的id

```http
POST /comment/showcomment HTTP/1.1

{
	id:
}
```

响应：data数据表示评论列表（原Commentinf类没有用户名，这里的用户名需要创建一个Commentinfo类的视图）

```http
HTTP/1.1 200 OK

{
	statusCode: 200
	statusCodeDescription: ""
	data: List<CommentinfoVO>
} 
```

CommentinfoVO类代码:

```java
package com.example.mycnblog.entity.vo;

import com.example.mycnblog.entity.Commentinfo;
import lombok.Data;

@Data
public class CommentVO extends Commentinfo {

    private String username;
}

```



---

#### 服务端开发

##### 控制层

```java
package com.example.mycnblog.controller;

import com.example.mycnblog.common.AjaxResult;
import com.example.mycnblog.common.UserSessionUtils;
import com.example.mycnblog.entity.Commentinfo;
import com.example.mycnblog.entity.Userinfo;
import com.example.mycnblog.service.CommentService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import java.util.HashMap;

@RestController
@RequestMapping("/comment")
public class CommentController {

    @Autowired
    private CommentService commentService;

    /**
     * 添加评论到这篇博客中，然后插入数据库
     * @param commentinfo 要插入的评论
     * @param request 请求
     * @return 返回统一格式
     */
    @RequestMapping("/add")
    public AjaxResult addComment(Commentinfo commentinfo, HttpServletRequest request) {
        if (commentinfo == null || !StringUtils.hasLength(commentinfo.getContent())) {
            return AjaxResult.fail(0, "参数错误");
        }
        if (commentinfo.getContent().length() > 50) {
            return AjaxResult.fail(2, "评论失败，请减少评论字数");
        }
        Userinfo userinfo = UserSessionUtils.getUser(request);
        if (userinfo == null) {
            return AjaxResult.fail(-1, "非法访问");
        }
        int row = commentService.addCommentService(commentinfo, userinfo);
        return AjaxResult.success(row);
    }

    @RequestMapping("/showcomment")
    public AjaxResult showComments(@RequestParam("id") Integer articleId) {
        if (articleId == null || articleId <= 0) {
            return AjaxResult.fail(0, "参数错误");
        }
        HashMap<String, Object> listMap = commentService.showCommentsService(articleId);
        return AjaxResult.success(listMap);
    }
}

```



---

##### 服务层

```java
package com.example.mycnblog.service;

import com.example.mycnblog.entity.Commentinfo;
import com.example.mycnblog.entity.Userinfo;
import com.example.mycnblog.mapper.CommentMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

@Service
public class CommentService {

    @Autowired
    private CommentMapper commentMapper;

    /**
     * 往数据库中添加评论
     *
     * @param commentinfo 要添加的评论
     * @param user        当前登录的用户
     * @return 返回受影响的行数
     */
    public int addCommentService(Commentinfo commentinfo, Userinfo user) {
        commentinfo.setUid(user.getId());

        return commentMapper.insertComment(commentinfo);
    }

    /**
     * 查找所有该文章的所有评论
     *
     * @param articleId 改文章的id
     * @return 返回所有评论
     */
    public HashMap<String, Object> showCommentsService(Integer articleId) {
        List<Commentinfo> commentList = commentMapper.selectComments(articleId);
        List<String> usernameList = new ArrayList<>();
        for (Commentinfo comment : commentList) {
            int userId = comment.getUid();
            String username = commentMapper.selectUsernameByUid(userId);
            usernameList.add(username);
        }
        HashMap<String, Object> listMap = new HashMap<>();
        listMap.put("commentList", commentList);
        listMap.put("usernameList", usernameList);
        return listMap;
    }

}
```



---

#### 客户端开发

评论接口没有专门的页面，是依据文章详情页面来和后端接口对接的，代码如下

```js
function send() {

        var content = document.getElementById("typing").value;

        var articleId = getUrlValue("id");

        jQuery.ajax({
            url: '/comment/add',
            type: 'post',
            data: {"content": content, "articleid": articleId},
            success: function (result) {
                if (result != null && result.statusCode == 200 && result.data == 1) {
                    // 添加评论在最上面
                    showComment(id);
                    location.href = location.href;
                }  else if (result != null && result.statusCode == -1) {
                    alert("请登录评论！");
                } else {
                    alert("评论失败！请重试");
                }
            }
        });
    }

    function showComment(id) {
        jQuery.ajax({
            url: '/comment/showcomment',
            type: 'post',
            data: {"id": id},
            success: function (result) {
                if (result != null && result.statusCode == 200 && result.data != null) {
                    var commentHtml = "";
                    var comments = result.data.commentList;
                    var usernames = result.data.usernameList;
                    for (var i = 0; i < usernames.length; i++) {
                        var comment = comments[i];
                        var username = usernames[i];
                        commentHtml += '<p class="para">' + '<br>' +
                            username + ": " + '<br>' + '<br>' +
                            comment.content + '<br>' + '<br>' +
                            comment.createtime + '<br>' + '<br>' + '</p>';
                        // 点赞功能，显示头像，进入主页
                    }
                    jQuery("#comment").html(commentHtml);
                }
            }
        });
    }
```
